(()=>{var V="https://acysegqhxdjhlhjotlhv.supabase.co",G="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeXNlZ3FoeGRqaGxoam90bGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODIzOTIsImV4cCI6MjA3MjM1ODM5Mn0.xYEIA_QPaaYJxGfuWzGDehrxJjETTR4A5T3votJb_8I",r=supabase.createClient(V,G);console.log("Supabase initialized.");document.addEventListener("DOMContentLoaded",()=>{let o={currentUser:null,items:[],favorites:[],sellFormFiles:[],currentView:"home"},e={homeView:document.getElementById("homeView"),loginForm:document.getElementById("loginForm"),sellForm:document.getElementById("sellForm"),myAdsView:document.getElementById("myAdsView"),favoritesView:document.getElementById("favoritesView"),adminView:document.getElementById("adminView"),importCreditsForm:document.getElementById("importCreditsForm"),userSection:document.getElementById("userSection"),loginSection:document.getElementById("loginSection"),showLoginBtn:document.getElementById("showLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),welcomeText:document.getElementById("welcomeText"),creditsDisplay:document.getElementById("creditsDisplay"),loginTitle:document.getElementById("loginTitle"),loginName:document.getElementById("loginName"),loginEmail:document.getElementById("loginEmail"),loginPhone:document.getElementById("loginPhone"),loginRegion:document.getElementById("loginRegion"),loginPassword:document.getElementById("loginPassword"),loginSubmit:document.getElementById("loginSubmit"),loginToggleBtn:document.getElementById("loginToggleBtn"),loginToggleText:document.getElementById("loginToggleText"),registerNote:document.getElementById("registerNote"),passwordGroup:document.getElementById("passwordGroup"),homeBtn:document.getElementById("homeBtn"),sellBtn:document.getElementById("sellBtn"),myAdsBtn:document.getElementById("myAdsBtn"),favBtn:document.getElementById("favBtn"),adminBtn:document.getElementById("adminBtn"),navButtons:document.querySelectorAll(".nav-btn"),submitBtn:document.getElementById("submitBtn"),itemTitle:document.getElementById("itemTitle"),itemPrice:document.getElementById("itemPrice"),itemCategory:document.getElementById("itemCategory"),itemDescription:document.getElementById("itemDescription"),itemLocation:document.getElementById("itemLocation"),itemWhatsApp:document.getElementById("itemWhatsApp"),previewSection:document.getElementById("previewSection"),remainingCredits:document.getElementById("remainingCredits"),noCreditsMsg:document.getElementById("noCreditsMsg"),itemsGrid:document.getElementById("itemsGrid"),noItemsMsg:document.getElementById("noItemsMsg"),itemCount:document.getElementById("itemCount"),showingCount:document.getElementById("showingCount"),totalCount:document.getElementById("totalCount"),favCount:document.getElementById("favCount"),favoritesCount:document.getElementById("favoritesCount"),favoritesGrid:document.getElementById("favoritesGrid"),noFavoritesMsg:document.getElementById("noFavoritesMsg"),importCreditsBtn:document.getElementById("importCreditsBtn"),searchInput:document.getElementById("searchInput"),categoryFilter:document.getElementById("categoryFilter")},w=[e.homeView,e.loginForm,e.sellForm,e.myAdsView,e.favoritesView,e.adminView,e.importCreditsForm],a=i=>{o.currentView=i,w.forEach(s=>s.classList.add("hidden")),e.navButtons.forEach(s=>s.classList.remove("active"));let t,n;switch(i){case"login":t=e.loginForm,e.loginEmail.value="",e.loginPhone.value="",e.loginPassword.value="",e.loginSubmit.classList.remove("hidden"),e.loginEmail.type="email",e.loginEmail.placeholder="Email";break;case"sell":t=e.sellForm,n=e.sellBtn,F();break;case"myAds":t=e.myAdsView,n=e.myAdsBtn;break;case"favorites":t=e.favoritesView,n=e.favBtn,p();break;case"admin":t=e.adminView,n=e.adminBtn;break;case"importCredits":t=e.importCreditsForm;break;case"home":default:t=e.homeView,n=e.homeBtn,g();break}t&&t.classList.remove("hidden"),n&&n.classList.add("active"),window.scrollTo(0,0)},I=()=>{o.currentUser&&o.currentUser.profile?(e.userSection.classList.remove("hidden"),e.loginSection.classList.add("hidden"),e.welcomeText.textContent=`Welcome, ${o.currentUser.profile.username}`,e.sellBtn.classList.remove("hidden"),e.myAdsBtn.classList.remove("hidden"),o.currentUser.profile.is_admin?(e.creditsDisplay.textContent="Unlimited Credits",e.adminBtn.classList.remove("hidden")):(e.creditsDisplay.textContent=`${o.currentUser.profile.listing_credits} Credits`,e.adminBtn.classList.add("hidden"))):(e.userSection.classList.add("hidden"),e.loginSection.classList.remove("hidden"),e.sellBtn.classList.add("hidden"),e.myAdsBtn.classList.add("hidden"),e.adminBtn.classList.add("hidden"))},h=i=>{e.itemsGrid.innerHTML="",i.length===0?e.noItemsMsg.classList.remove("hidden"):e.noItemsMsg.classList.add("hidden"),e.itemCount.textContent=i.length,e.showingCount.textContent=i.length,e.totalCount.textContent=i.length,i.forEach(t=>{let n=o.favorites.includes(t.id),s=document.createElement("div");s.className="card item-card",s.dataset.id=t.id,s.innerHTML=`
                <img src="${t.images&&t.images.length>0?t.images[0]:"https://placehold.co/300x200?text=No+Image"}" alt="${t.title}" class="item-image">
                <div class="item-content">
                    <div class="item-meta">
                        <span class="category-badge">${t.category}</span>
                        <span class="text-xs text-gray-500">${new Date(t.posted_at).toLocaleDateString()}</span>
                    </div>
                    <h3 class="item-title">${t.title}</h3>
                    <p class="item-description">${t.description}</p>
                </div>
                <div class="item-footer">
                    <div class="item-price">GHS ${t.price}</div>
                    <div class="item-actions">
                        <a href="https://wa.me/${t.whatsapp.replace("+","")}?text=Hi, I'm interested in your '${t.title}' on Ghana Market." target="_blank" class="btn btn-sm btn-primary">
                            <i data-lucide="message-circle"></i><span>WhatsApp</span>
                        </a>
                        <button class="btn btn-sm btn-secondary favorite-toggle-btn">
                            <i data-lucide="heart" ${n?'fill="red"':""}></i>
                        </button>
                    </div>
                </div>
            `,e.itemsGrid.appendChild(s)}),lucide.createIcons()},L=()=>{let i=o.favorites.length;e.favCount.textContent=i,e.favoritesCount&&(e.favoritesCount.textContent=i)},C=async i=>{if(!o.currentUser){alert("Please login to add items to your favorites."),a("login");return}let t=o.favorites.indexOf(i),n=[...o.favorites];t>-1?n.splice(t,1):n.push(i);try{let{error:s}=await r.from("profiles").update({favorites:n}).eq("id",o.currentUser.user.id);if(s)throw s;o.favorites=n,o.currentUser.profile.favorites=n}catch(s){console.error("Error updating favorites:",s),alert("Could not update favorites. Please try again.");return}L(),o.currentView==="home"&&g(),o.currentView==="favorites"&&p()},p=async()=>{if(!o.favorites||o.favorites.length===0){e.favoritesGrid.innerHTML="",e.noFavoritesMsg.classList.remove("hidden");return}e.noFavoritesMsg.classList.add("hidden"),e.favoritesGrid.innerHTML="Loading favorites...";let{data:i,error:t}=await r.from("items").select("*").in("id",o.favorites);if(t){console.error("Error fetching favorite items:",t),e.favoritesGrid.innerHTML='<p class="text-red-500">Could not load favorites.</p>';return}h(i)},b=async i=>{if(i.preventDefault(),!o.currentUser){alert("You must be logged in to sell an item.");return}let t=e.itemTitle.value.trim(),n=parseFloat(e.itemPrice.value),s=e.itemCategory.value,l=e.itemDescription.value.trim(),d=e.itemLocation.value.trim(),c=e.itemWhatsApp.value.trim(),U=document.querySelector('input[name="deliveryType"]:checked').value;if(!t||!n||!s||!l||!d||!c){alert("Please fill out all required fields.");return}if(o.sellFormFiles.length===0){alert("Please upload at least one image for your item.");return}e.submitBtn.disabled=!0,e.submitBtn.innerHTML='<i data-lucide="loader-2" class="animate-spin"></i><span>Uploading...</span>',lucide.createIcons();try{let u=o.sellFormFiles.map(m=>{let f=`${Date.now()}-${m.name}`,k=`${o.currentUser.user.id}/${f}`;return r.storage.from("item-images").upload(k,m)}),y=await Promise.all(u),B=y.filter(m=>m.error);if(B.length>0)throw new Error(`Image upload failed: ${B[0].error.message}`);let M=y.map(m=>{let{data:f}=r.storage.from("item-images").getPublicUrl(m.data.path);return f.publicUrl}),A={title:t,price:n,category:s,description:l,location:d,whatsapp:c,delivery:U,images:M,seller_id:o.currentUser.user.id,status:"active"},{error:E}=await r.from("items").insert([A]);if(E)throw E;alert("Item listed successfully!"),x(),a("home")}catch(u){console.error("Error listing item:",u),alert(`There was an error listing your item: ${u.message}`)}finally{e.submitBtn.disabled=!1,e.submitBtn.innerHTML='<i data-lucide="plus-circle"></i><span>List Item (1 Credit)</span>',lucide.createIcons()}},x=()=>{e.sellForm.querySelector("form")?.reset(),o.sellFormFiles=[],e.previewSection.innerHTML=""},F=()=>{if(o.currentUser)if(o.currentUser.profile?.is_admin)e.remainingCredits.textContent="Unlimited",e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1;else{let i=o.currentUser.profile?.listing_credits||0;e.remainingCredits.textContent=i.toString(),i>0?(e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1):(e.noCreditsMsg.classList.remove("hidden"),e.submitBtn.disabled=!0)}},v=i=>{i?(e.loginTitle.textContent="Create Account",e.loginName.classList.remove("hidden"),e.loginRegion.classList.remove("hidden"),e.registerNote.classList.remove("hidden"),e.loginSubmit.textContent="Register",e.loginToggleText.textContent="Already have an account?",e.loginToggleBtn.textContent="Login",e.loginEmail.type="email",e.loginEmail.placeholder="Email",e.loginPhone.classList.remove("hidden"),e.passwordGroup.classList.remove("hidden"),e.loginSubmit.classList.remove("hidden")):(e.loginTitle.textContent="Welcome Back",e.loginName.classList.add("hidden"),e.loginRegion.classList.add("hidden"),e.registerNote.classList.add("hidden"),e.loginSubmit.textContent="Login",e.loginToggleText.textContent="Don't have an account?",e.loginToggleBtn.textContent="Register",e.loginPhone.classList.add("hidden"),e.loginEmail.type="email",e.loginEmail.placeholder="Email")},T=async()=>{try{console.log("Logging out with Supabase...");let{error:i}=await r.auth.signOut();if(i)throw i}catch(i){alert(`Logout failed: ${i.message}`)}},$=async()=>{let i=prompt("Please enter your email address to reset your password:");if(i)try{let{error:t}=await r.auth.resetPasswordForEmail(i,{redirectTo:window.location.origin+"/update-password"});if(t)throw t;alert("Password reset email sent! Please check your inbox.")}catch(t){alert(`Error sending password reset email: ${t.message}`)}},g=async()=>{let i=e.searchInput.value.toLowerCase(),t=e.categoryFilter.value;try{let n=r.from("items").select("*").order("posted_at",{ascending:!1});t!=="all"&&(n=n.eq("category",t));let{data:s,error:l}=await n;if(l)throw l;let d=s;i&&(d=s.filter(c=>c.title.toLowerCase().includes(i)||c.description.toLowerCase().includes(i))),o.items=d,h(o.items)}catch(n){console.error("Error fetching items:",n),e.itemsGrid.innerHTML='<p class="text-center text-red-500">Could not load items. Please try again later.</p>'}},P=async()=>{let i=e.loginEmail.value.trim(),t=e.loginPassword.value.trim();if(!i||!t){alert("Please enter both email and password.");return}try{let{error:n}=await r.auth.signInWithPassword({email:i,password:t});if(n)throw n;a("home")}catch(n){alert(`Login failed: ${n.message}`)}},S=async()=>{let i=e.loginEmail.value.trim(),t=e.loginPassword.value.trim(),n=e.loginName.value.trim(),s=e.loginPhone.value.trim(),l=e.loginRegion.value;if(!i||!t||!n||!s||!l){alert("Please fill out all fields for registration.");return}try{let{data:d,error:c}=await r.auth.signUp({email:i,password:t,options:{data:{username:n,phone:s,region:l}}});if(c)throw c;d.user?.identities?.length===0?alert("Could not register user. A user with this email may already exist and is unconfirmed."):(alert("Registration successful! Please check your email to confirm your account."),v(!1))}catch(d){alert(`Registration failed: ${d.message}`)}};e.showLoginBtn.addEventListener("click",()=>a("login")),e.homeBtn.addEventListener("click",()=>a("home")),e.sellBtn.addEventListener("click",()=>a("sell")),e.myAdsBtn.addEventListener("click",()=>a("myAds")),e.favBtn.addEventListener("click",()=>a("favorites")),e.adminBtn.addEventListener("click",()=>a("admin")),e.submitBtn.addEventListener("click",b),e.importCreditsBtn.addEventListener("click",()=>a("importCredits")),e.logoutBtn.addEventListener("click",T),e.loginToggleBtn.addEventListener("click",()=>{let i=e.loginSubmit.textContent==="Login";v(i)}),e.loginSubmit.addEventListener("click",i=>{i.preventDefault(),e.loginSubmit.textContent==="Login"?P():S()}),e.searchInput.addEventListener("input",g),e.categoryFilter.addEventListener("change",g),document.body.addEventListener("click",i=>{let t=i.target.closest(".favorite-toggle-btn");if(t){let n=t.closest(".item-card");n&&C(n.dataset.id)}}),(()=>{r.auth.onAuthStateChange(async(i,t)=>{let n=t?.user||null;if(n){console.log("Auth state changed: User signed in ->",n.id);let{data:s,error:l}=await r.from("profiles").select("*").eq("id",n.id).single();if(l&&l.code!=="PGRST116")console.error("Error fetching user profile:",l),o.currentUser=null,o.favorites=[];else if(s)o.currentUser={user:n,profile:s},o.favorites=s.favorites||[];else{console.warn("Profile not found, creating one as a fallback.");let{data:d,error:c}=await r.from("profiles").insert([{id:n.id,username:n.user_metadata.username||"New User"}]).select().single();c?(console.error("Error creating user profile:",c),o.currentUser={user:n,profile:null},o.favorites=[]):(o.currentUser={user:n,profile:d},o.favorites=d.favorites||[])}}else console.log("Auth state changed: User signed out."),o.currentUser=null,o.favorites=[];I(),o.currentView!=="login"&&o.currentView!=="register"&&a("home")}),a("home"),lucide.createIcons()})()});})();
//# sourceMappingURL=app.js.map
