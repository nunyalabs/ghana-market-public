(()=>{var D="https://acysegqhxdjhlhjotlhv.supabase.co",N="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeXNlZ3FoeGRqaGxoam90bGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODIzOTIsImV4cCI6MjA3MjM1ODM5Mn0.xYEIA_QPaaYJxGfuWzGDehrxJjETTR4A5T3votJb_8I",a=supabase.createClient(D,N);console.log("Supabase initialized.");document.addEventListener("DOMContentLoaded",()=>{let o={currentUser:null,items:[],favorites:[],sellFormFiles:[],currentView:"home"},e={homeView:document.getElementById("homeView"),loginForm:document.getElementById("loginForm"),sellForm:document.getElementById("sellForm"),myAdsView:document.getElementById("myAdsView"),favoritesView:document.getElementById("favoritesView"),adminView:document.getElementById("adminView"),importCreditsForm:document.getElementById("importCreditsForm"),userSection:document.getElementById("userSection"),loginSection:document.getElementById("loginSection"),showLoginBtn:document.getElementById("showLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),welcomeText:document.getElementById("welcomeText"),creditsDisplay:document.getElementById("creditsDisplay"),loginTitle:document.getElementById("loginTitle"),loginName:document.getElementById("loginName"),loginEmail:document.getElementById("loginEmail"),loginPhone:document.getElementById("loginPhone"),loginRegion:document.getElementById("loginRegion"),loginPassword:document.getElementById("loginPassword"),loginSubmit:document.getElementById("loginSubmit"),loginToggleBtn:document.getElementById("loginToggleBtn"),loginToggleText:document.getElementById("loginToggleText"),registerNote:document.getElementById("registerNote"),forgotPasswordLink:document.getElementById("forgotPasswordLink"),otpInput:document.getElementById("otpInput"),verifyOtpBtn:document.getElementById("verifyOtpBtn"),passwordGroup:document.getElementById("passwordGroup"),otpGroup:document.getElementById("otpGroup"),emailPhoneToggle:document.getElementById("emailPhoneToggle"),loginEmailPhoneLabel:document.getElementById("loginEmailPhoneLabel"),navButtons:document.querySelectorAll(".nav-btn"),homeBtn:document.getElementById("homeBtn"),sellBtn:document.getElementById("sellBtn"),myAdsBtn:document.getElementById("myAdsBtn"),favBtn:document.getElementById("favBtn"),adminBtn:document.getElementById("adminBtn"),importCreditsBtn:document.getElementById("importCreditsBtn"),itemsGrid:document.getElementById("itemsGrid"),noItemsMsg:document.getElementById("noItemsMsg"),itemCount:document.getElementById("itemCount"),showingCount:document.getElementById("showingCount"),totalCount:document.getElementById("totalCount"),searchInput:document.getElementById("searchInput"),categoryFilter:document.getElementById("categoryFilter"),favCount:document.getElementById("favCount"),favoritesGrid:document.getElementById("favoritesGrid"),noFavoritesMsg:document.getElementById("noFavoritesMsg"),favoritesCount:document.getElementById("favoritesCount"),remainingCredits:document.getElementById("remainingCredits"),noCreditsMsg:document.getElementById("noCreditsMsg"),submitBtn:document.getElementById("submitBtn"),itemTitle:document.getElementById("itemTitle"),itemPrice:document.getElementById("itemPrice"),itemCategory:document.getElementById("itemCategory"),itemDescription:document.getElementById("itemDescription"),itemLocation:document.getElementById("itemLocation"),itemWhatsApp:document.getElementById("itemWhatsApp"),fileInput:document.getElementById("fileInput"),previewSection:document.getElementById("previewSection")},b=[e.homeView,e.loginForm,e.sellForm,e.myAdsView,e.favoritesView,e.adminView,e.importCreditsForm],l=t=>{o.currentView=t,b.forEach(s=>s.classList.add("hidden")),e.navButtons.forEach(s=>s.classList.remove("active"));let i,n;switch(t){case"login":i=e.loginForm,e.loginEmail.value="",e.loginPhone.value="",e.loginPassword.value="",e.otpInput.value="",e.passwordGroup.classList.remove("hidden"),e.otpGroup.classList.add("hidden"),e.loginSubmit.classList.remove("hidden"),e.verifyOtpBtn.classList.add("hidden"),e.loginEmail.type="email",e.loginEmail.placeholder="Email",e.loginEmailPhoneLabel.textContent="Email";break;case"sell":i=e.sellForm,n=e.sellBtn,S();break;case"myAds":i=e.myAdsView,n=e.myAdsBtn;break;case"favorites":i=e.favoritesView,n=e.favBtn,y();break;case"admin":i=e.adminView,n=e.adminBtn;break;case"importCredits":i=e.importCreditsForm;break;case"home":default:i=e.homeView,n=e.homeBtn,p();break}i&&i.classList.remove("hidden"),n&&n.classList.add("active"),window.scrollTo(0,0)},P=()=>{o.currentUser&&o.currentUser.profile?(e.userSection.classList.remove("hidden"),e.loginSection.classList.add("hidden"),e.welcomeText.textContent=`Welcome, ${o.currentUser.profile.username}`,e.sellBtn.classList.remove("hidden"),e.myAdsBtn.classList.remove("hidden"),o.currentUser.profile.is_admin?(e.creditsDisplay.textContent="Unlimited Credits",e.adminBtn.classList.remove("hidden"),e.importCreditsBtn.classList.add("hidden")):(e.creditsDisplay.textContent=`${o.currentUser.profile.listing_credits} Credits`,e.adminBtn.classList.add("hidden"),e.importCreditsBtn.classList.remove("hidden"))):(e.userSection.classList.add("hidden"),e.loginSection.classList.remove("hidden"),e.sellBtn.classList.add("hidden"),e.myAdsBtn.classList.add("hidden"),e.adminBtn.classList.add("hidden")),v()},f=t=>{e.itemsGrid.innerHTML="",t.length===0?e.noItemsMsg.classList.remove("hidden"):e.noItemsMsg.classList.add("hidden"),e.itemCount.textContent=t.length,e.showingCount.textContent=t.length,e.totalCount.textContent=t.length,t.forEach(i=>{let n=o.favorites.includes(i.id),s=document.createElement("div");s.className="card item-card",s.dataset.id=i.id,s.innerHTML=`
                <img src="${i.images&&i.images.length>0?i.images[0]:"https://placehold.co/300x200?text=No+Image"}" alt="${i.title}" class="item-image">
                <div class="item-content">
                    <div class="item-meta">
                        <span class="category-badge">${i.category}</span>
                        <span class="text-xs text-gray-500">${new Date(i.posted_at).toLocaleDateString()}</span>
                    </div>
                    <h3 class="item-title">${i.title}</h3>
                    <p class="item-description">${i.description}</p>
                </div>
                <div class="item-footer">
                    <div class="item-price">GHS ${i.price}</div>
                    <div class="item-actions">
                        <a href="https://wa.me/${i.whatsapp.replace("+","")}?text=Hi, I'm interested in your '${i.title}' on Ghana Market." target="_blank" class="btn btn-sm btn-primary">
                            <i data-lucide="message-circle"></i><span>WhatsApp</span>
                        </a>
                        <button class="btn btn-sm btn-secondary favorite-toggle-btn">
                            <i data-lucide="heart" ${n?'fill="red"':""}></i>
                        </button>
                    </div>
                </div>
            `,e.itemsGrid.appendChild(s)}),lucide.createIcons()},v=()=>{let t=o.favorites.length;e.favCount.textContent=t,e.favoritesCount&&(e.favoritesCount.textContent=t)},T=async t=>{if(!o.currentUser){alert("Please login to add items to your favorites."),l("login");return}let i=o.favorites.indexOf(t),n=[...o.favorites];i>-1?n.splice(i,1):n.push(t);try{let{error:s}=await a.from("profiles").update({favorites:n}).eq("id",o.currentUser.user.id);if(s)throw s;o.favorites=n,o.currentUser.profile.favorites=n}catch(s){console.error("Error updating favorites:",s),alert("Could not update favorites. Please try again.");return}v(),o.currentView==="home"&&p(),o.currentView==="favorites"&&y()},y=async()=>{if(!o.favorites||o.favorites.length===0){e.favoritesGrid.innerHTML="",e.noFavoritesMsg.classList.remove("hidden");return}e.noFavoritesMsg.classList.add("hidden"),e.favoritesGrid.innerHTML="Loading favorites...";let{data:t,error:i}=await a.from("items").select("*").in("id",o.favorites);if(i){console.error("Error fetching favorite items:",i),e.favoritesGrid.innerHTML='<p class="text-red-500">Could not load favorites.</p>';return}f(t)},x=async t=>{if(t.preventDefault(),!o.currentUser){alert("You must be logged in to sell an item.");return}let{is_admin:i,listing_credits:n}=o.currentUser.profile;if(!i&&n<1){alert("You do not have enough credits to list an item.");return}let s=e.itemTitle.value.trim(),d=parseFloat(e.itemPrice.value),r=e.itemCategory.value,c=e.itemDescription.value.trim(),g=e.itemLocation.value.trim(),w=e.itemWhatsApp.value.trim(),M=document.querySelector('input[name="deliveryType"]:checked').value;if(!s||!d||!r||!c||!g||!w){alert("Please fill out all required fields.");return}if(o.sellFormFiles.length===0){alert("Please upload at least one image for your item.");return}e.submitBtn.disabled=!0,e.submitBtn.innerHTML='<i data-lucide="loader-2" class="animate-spin"></i><span>Uploading...</span>',lucide.createIcons();try{let h=o.sellFormFiles.map(m=>{let u=`${Date.now()}-${m.name}`,$=`${o.currentUser.user.id}/${u}`;return a.storage.from("item-images").upload($,m)}),I=await Promise.all(h),L=I.filter(m=>m.error);if(L.length>0)throw new Error(`Image upload failed: ${L[0].error.message}`);let O=I.map(m=>{let{data:u}=a.storage.from("item-images").getPublicUrl(m.data.path);return u.publicUrl}),V={title:s,price:d,category:r,description:c,location:g,whatsapp:w,delivery:M,images:O,seller_id:o.currentUser.user.id,status:"active"},{error:C}=await a.from("items").insert([V]);if(C)throw C;if(!i){let m=o.currentUser.profile.listing_credits-1,{error:u}=await a.from("profiles").update({listing_credits:m}).eq("id",o.currentUser.user.id);u?console.error("Failed to deduct credit, but item was listed:",u):o.currentUser.profile.listing_credits=m}alert("Item listed successfully!"),F(),l("home")}catch(h){console.error("Error listing item:",h),alert(`There was an error listing your item: ${h.message}`)}finally{e.submitBtn.disabled=!1,e.submitBtn.innerHTML='<i data-lucide="plus-circle"></i><span>List Item (1 Credit)</span>',lucide.createIcons()}},F=()=>{e.sellForm.querySelector("form")?.reset(),o.sellFormFiles=[],e.previewSection.innerHTML=""},S=()=>{if(o.currentUser)if(o.currentUser.profile?.is_admin)e.remainingCredits.textContent="Unlimited",e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1;else{let t=o.currentUser.profile?.listing_credits||0;e.remainingCredits.textContent=t.toString(),t>0?(e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1):(e.noCreditsMsg.classList.remove("hidden"),e.submitBtn.disabled=!0)}},B=t=>{t?(e.loginTitle.textContent="Create Account",e.loginName.classList.remove("hidden"),e.loginRegion.classList.remove("hidden"),e.registerNote.classList.remove("hidden"),e.loginSubmit.textContent="Register",e.loginToggleText.textContent="Already have an account?",e.loginToggleBtn.textContent="Login",e.loginEmail.type="email",e.loginEmail.placeholder="Email",e.loginEmailPhoneLabel.textContent="Email",e.loginPhone.classList.remove("hidden"),e.passwordGroup.classList.remove("hidden"),e.otpGroup.classList.add("hidden"),e.loginSubmit.classList.remove("hidden"),e.verifyOtpBtn.classList.add("hidden")):(e.loginTitle.textContent="Welcome Back",e.loginName.classList.add("hidden"),e.loginRegion.classList.add("hidden"),e.registerNote.classList.add("hidden"),e.loginSubmit.textContent="Login",e.loginToggleText.textContent="Don't have an account?",e.loginToggleBtn.textContent="Register",e.loginPhone.classList.add("hidden"),e.otpGroup.classList.add("hidden"),e.verifyOtpBtn.classList.add("hidden"),e.passwordGroup.classList.remove("hidden"),e.loginSubmit.classList.remove("hidden"))},U=async()=>{let t=e.loginEmail.value.trim(),i=e.loginPhone.value.trim(),n=e.loginPassword.value;if(!t&&!i){alert("Please enter your Email or Phone Number.");return}try{console.log("Attempting login with Supabase...");let s;if(t){if(!n){alert("Please enter your password.");return}({error:s}=await a.auth.signInWithPassword({email:t,password:n}))}else i&&({error:s}=await a.auth.signInWithOtp({phone:i}),s||(alert("OTP sent to your phone. Please enter it to log in."),e.passwordGroup.classList.add("hidden"),e.loginSubmit.classList.add("hidden"),e.otpGroup.classList.remove("hidden"),e.verifyOtpBtn.classList.remove("hidden"),e.loginEmail.type="tel",e.loginEmail.placeholder="Phone Number",e.loginEmailPhoneLabel.textContent="Phone Number"));if(s)throw s}catch(s){alert(`Login failed: ${s.message}`)}},E=async()=>{let t=e.loginPhone.value.trim(),i=e.otpInput.value.trim();if(!t||!i){alert("Please enter your phone number and the OTP.");return}try{console.log("Attempting OTP verification with Supabase...");let{error:n}=await a.auth.verifyOtp({phone:t,token:i,type:"sms"});if(n)throw n;alert("OTP verified successfully! You are now logged in."),l("home")}catch(n){alert(`OTP verification failed: ${n.message}`)}},k=async()=>{let t=e.loginName.value,i=e.loginEmail.value,n=e.loginPhone.value,s=e.loginRegion.value,d=e.loginPassword.value;if(!t||!s||!d){alert("Please fill in Name, Region, and Password.");return}if(!i&&!n){alert("Please provide either an Email or a Phone Number.");return}try{console.log("Attempting registration with Supabase...");let r={password:d,options:{data:{username:t,region:s}}};i?(r.email=i,r.options.data.phone=n):n&&(r.phone=n,r.options.data.email=i);let{data:c,error:g}=await a.auth.signUp(r);if(g)throw g;c.user?.identities?.length===0?alert("Could not register user. A user with this email may already exist and is unconfirmed."):(alert("Registration successful! Please check your email to confirm your account."),B(!1))}catch(r){alert(`Registration failed: ${r.message}`)}},A=async()=>{try{console.log("Logging out with Supabase...");let{error:t}=await a.auth.signOut();if(t)throw t}catch(t){alert(`Logout failed: ${t.message}`)}},G=async()=>{let t=prompt("Please enter your email address to reset your password:");if(t)try{let{error:i}=await a.auth.resetPasswordForEmail(t,{redirectTo:window.location.origin+"/update-password"});if(i)throw i;alert("Password reset email sent! Please check your inbox.")}catch(i){alert(`Error sending password reset email: ${i.message}`)}},p=async()=>{let t=e.searchInput.value.toLowerCase(),i=e.categoryFilter.value;try{let n=a.from("items").select("*").order("posted_at",{ascending:!1});i!=="all"&&(n=n.eq("category",i));let{data:s,error:d}=await n;if(d)throw d;let r=s;t&&(r=s.filter(c=>c.title.toLowerCase().includes(t)||c.description.toLowerCase().includes(t))),o.items=r,f(o.items)}catch(n){console.error("Error fetching items:",n),e.itemsGrid.innerHTML='<p class="text-center text-red-500">Could not load items. Please try again later.</p>'}};e.showLoginBtn.addEventListener("click",()=>l("login")),e.homeBtn.addEventListener("click",()=>l("home")),e.sellBtn.addEventListener("click",()=>l("sell")),e.myAdsBtn.addEventListener("click",()=>l("myAds")),e.favBtn.addEventListener("click",()=>l("favorites")),e.adminBtn.addEventListener("click",()=>l("admin")),e.submitBtn.addEventListener("click",x),e.importCreditsBtn.addEventListener("click",()=>l("importCredits")),e.logoutBtn.addEventListener("click",A),e.loginToggleBtn.addEventListener("click",()=>{let t=e.loginSubmit.textContent==="Login";B(t)}),e.loginSubmit.addEventListener("click",t=>{t.preventDefault(),e.loginSubmit.textContent==="Login"?U():k()}),e.forgotPasswordLink.addEventListener("click",t=>{t.preventDefault(),G()}),e.verifyOtpBtn.addEventListener("click",t=>{t.preventDefault(),E()}),e.verifyOtpBtn.addEventListener("click",t=>{t.preventDefault(),E()}),e.searchInput.addEventListener("input",p),e.categoryFilter.addEventListener("change",p),document.body.addEventListener("click",t=>{let i=t.target.closest(".favorite-toggle-btn");if(i){let n=i.closest(".item-card");n&&T(n.dataset.id)}}),(()=>{a.auth.onAuthStateChange(async(t,i)=>{let n=i?.user||null;if(n){console.log("Auth state changed: User signed in ->",n.id);let{data:s,error:d}=await a.from("profiles").select("*").eq("id",n.id).single();if(d&&d.code!=="PGRST116")console.error("Error fetching user profile:",d),o.currentUser=null,o.favorites=[];else if(s)o.currentUser={user:n,profile:s},o.favorites=s.favorites||[];else{console.warn("Profile not found, creating one as a fallback.");let{data:r,error:c}=await a.from("profiles").insert([{id:n.id,username:n.user_metadata.username||"New User"}]).select().single();c?(console.error("Error creating user profile:",c),o.currentUser={user:n,profile:null},o.favorites=[]):(o.currentUser={user:n,profile:r},o.favorites=r.favorites||[])}}else console.log("Auth state changed: User signed out."),o.currentUser=null,o.favorites=[];P(),o.currentView!=="login"&&o.currentView!=="register"&&l("home")}),l("home"),lucide.createIcons()})()});})();
//# sourceMappingURL=app.js.map
