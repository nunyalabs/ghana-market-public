(()=>{var D="https://acysegqhxdjhlhjotlhv.supabase.co",G="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeXNlZ3FoeGRqaGxoam90bGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODIzOTIsImV4cCI6MjA3MjM1ODM5Mn0.xYEIA_QPaaYJxGfuWzGDehrxJjETTR4A5T3votJb_8I",r=supabase.createClient(D,G);console.log("Supabase initialized.");document.addEventListener("DOMContentLoaded",()=>{let t={currentUser:null,items:[],favorites:[],sellFormFiles:[],currentView:"home"},e={homeView:document.getElementById("homeView"),loginForm:document.getElementById("loginForm"),sellForm:document.getElementById("sellForm"),myAdsView:document.getElementById("myAdsView"),favoritesView:document.getElementById("favoritesView"),adminView:document.getElementById("adminView"),importCreditsForm:document.getElementById("importCreditsForm"),userSection:document.getElementById("userSection"),loginSection:document.getElementById("loginSection"),showLoginBtn:document.getElementById("showLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),welcomeText:document.getElementById("welcomeText"),creditsDisplay:document.getElementById("creditsDisplay"),loginTitle:document.getElementById("loginTitle"),loginName:document.getElementById("loginName"),loginEmail:document.getElementById("loginEmail"),loginPhone:document.getElementById("loginPhone"),loginRegion:document.getElementById("loginRegion"),loginPassword:document.getElementById("loginPassword"),loginSubmit:document.getElementById("loginSubmit"),loginToggleBtn:document.getElementById("loginToggleBtn"),loginToggleText:document.getElementById("loginToggleText"),registerNote:document.getElementById("registerNote"),navButtons:document.querySelectorAll(".nav-btn"),homeBtn:document.getElementById("homeBtn"),sellBtn:document.getElementById("sellBtn"),myAdsBtn:document.getElementById("myAdsBtn"),favBtn:document.getElementById("favBtn"),adminBtn:document.getElementById("adminBtn"),importCreditsBtn:document.getElementById("importCreditsBtn"),itemsGrid:document.getElementById("itemsGrid"),noItemsMsg:document.getElementById("noItemsMsg"),itemCount:document.getElementById("itemCount"),showingCount:document.getElementById("showingCount"),totalCount:document.getElementById("totalCount"),searchInput:document.getElementById("searchInput"),categoryFilter:document.getElementById("categoryFilter"),favCount:document.getElementById("favCount"),favoritesGrid:document.getElementById("favoritesGrid"),noFavoritesMsg:document.getElementById("noFavoritesMsg"),favoritesCount:document.getElementById("favoritesCount"),remainingCredits:document.getElementById("remainingCredits"),noCreditsMsg:document.getElementById("noCreditsMsg"),submitBtn:document.getElementById("submitBtn"),itemTitle:document.getElementById("itemTitle"),itemPrice:document.getElementById("itemPrice"),itemCategory:document.getElementById("itemCategory"),itemDescription:document.getElementById("itemDescription"),itemLocation:document.getElementById("itemLocation"),itemWhatsApp:document.getElementById("itemWhatsApp"),fileInput:document.getElementById("fileInput"),previewSection:document.getElementById("previewSection")},L=[e.homeView,e.loginForm,e.sellForm,e.myAdsView,e.favoritesView,e.adminView,e.importCreditsForm],a=s=>{t.currentView=s,L.forEach(o=>o.classList.add("hidden")),e.navButtons.forEach(o=>o.classList.remove("active"));let n,i;switch(s){case"login":n=e.loginForm;break;case"sell":n=e.sellForm,i=e.sellBtn,U();break;case"myAds":n=e.myAdsView,i=e.myAdsBtn;break;case"favorites":n=e.favoritesView,i=e.favBtn,v();break;case"admin":n=e.adminView,i=e.adminBtn;break;case"importCredits":n=e.importCreditsForm;break;case"home":default:n=e.homeView,i=e.homeBtn,u();break}n&&n.classList.remove("hidden"),i&&i.classList.add("active"),window.scrollTo(0,0)},b=()=>{t.currentUser&&t.currentUser.profile?(e.userSection.classList.remove("hidden"),e.loginSection.classList.add("hidden"),e.welcomeText.textContent=`Welcome, ${t.currentUser.profile.name.split(" ")[0]}`,e.sellBtn.classList.remove("hidden"),e.myAdsBtn.classList.remove("hidden"),t.currentUser.profile.is_admin?(e.creditsDisplay.textContent="Unlimited Credits",e.adminBtn.classList.remove("hidden"),e.importCreditsBtn.classList.add("hidden")):(e.creditsDisplay.textContent=`${t.currentUser.profile.listing_credits} Credits`,e.adminBtn.classList.add("hidden"),e.importCreditsBtn.classList.remove("hidden"))):(e.userSection.classList.add("hidden"),e.loginSection.classList.remove("hidden"),e.sellBtn.classList.add("hidden"),e.myAdsBtn.classList.add("hidden"),e.adminBtn.classList.add("hidden")),p()},h=s=>{e.itemsGrid.innerHTML="",s.length===0?e.noItemsMsg.classList.remove("hidden"):e.noItemsMsg.classList.add("hidden"),e.itemCount.textContent=s.length,e.showingCount.textContent=s.length,e.totalCount.textContent=s.length,s.forEach(n=>{let i=t.favorites.includes(n.id),o=document.createElement("div");o.className="card item-card",o.dataset.id=n.id,o.innerHTML=`
                <img src="${n.images&&n.images.length>0?n.images[0]:"https://placehold.co/300x200?text=No+Image"}" alt="${n.title}" class="item-image">
                <div class="item-content">
                    <div class="item-meta">
                        <span class="category-badge">${n.category}</span>
                        <span class="text-xs text-gray-500">${new Date(n.posted_at).toLocaleDateString()}</span>
                    </div>
                    <h3 class="item-title">${n.title}</h3>
                    <p class="item-description">${n.description}</p>
                </div>
                <div class="item-footer">
                    <div class="item-price">GHS ${n.price}</div>
                    <div class="item-actions">
                        <a href="https://wa.me/${n.whatsapp.replace("+","")}?text=Hi, I'm interested in your '${n.title}' on Ghana Market." target="_blank" class="btn btn-sm btn-primary">
                            <i data-lucide="message-circle"></i><span>WhatsApp</span>
                        </a>
                        <button class="btn btn-sm btn-secondary favorite-toggle-btn">
                            <i data-lucide="heart" ${i?'fill="red"':""}></i>
                        </button>
                    </div>
                </div>
            `,e.itemsGrid.appendChild(o)}),lucide.createIcons()},p=()=>{let s=t.favorites.length;e.favCount.textContent=s,e.favoritesCount&&(e.favoritesCount.textContent=s)},x=async s=>{if(!t.currentUser){alert("Please login to add items to your favorites."),a("login");return}let n=t.favorites.indexOf(s),i=[...t.favorites];n>-1?i.splice(n,1):i.push(s);try{let{error:o}=await r.from("profiles").update({favorites:i}).eq("id",t.currentUser.user.id);if(o)throw o;t.favorites=i,t.currentUser.profile.favorites=i}catch(o){console.error("Error updating favorites:",o),alert("Could not update favorites. Please try again.");return}p(),t.currentView==="home"&&u(),t.currentView==="favorites"&&v()},v=async()=>{if(!t.favorites||t.favorites.length===0){e.favoritesGrid.innerHTML="",e.noFavoritesMsg.classList.remove("hidden");return}e.noFavoritesMsg.classList.add("hidden"),e.favoritesGrid.innerHTML="Loading favorites...";let{data:s,error:n}=await r.from("items").select("*").in("id",t.favorites);if(n){console.error("Error fetching favorite items:",n),e.favoritesGrid.innerHTML='<p class="text-red-500">Could not load favorites.</p>';return}h(s)},F=async s=>{if(s.preventDefault(),!t.currentUser){alert("You must be logged in to sell an item.");return}let{is_admin:n,listing_credits:i}=t.currentUser.profile;if(!n&&i<1){alert("You do not have enough credits to list an item.");return}let o=e.itemTitle.value.trim(),l=parseFloat(e.itemPrice.value),d=e.itemCategory.value,c=e.itemDescription.value.trim(),B=e.itemLocation.value.trim(),I=e.itemWhatsApp.value.trim(),P=document.querySelector('input[name="deliveryType"]:checked').value;if(!o||!l||!d||!c||!B||!I){alert("Please fill out all required fields.");return}if(t.sellFormFiles.length===0){alert("Please upload at least one image for your item.");return}e.submitBtn.disabled=!0,e.submitBtn.innerHTML='<i data-lucide="loader-2" class="animate-spin"></i><span>Uploading...</span>',lucide.createIcons();try{let f=t.sellFormFiles.map(m=>{let g=`${Date.now()}-${m.name}`,$=`${t.currentUser.user.id}/${g}`;return r.storage.from("item-images").upload($,m)}),E=await Promise.all(f),w=E.filter(m=>m.error);if(w.length>0)throw new Error(`Image upload failed: ${w[0].error.message}`);let k=E.map(m=>{let{data:g}=r.storage.from("item-images").getPublicUrl(m.data.path);return g.publicUrl}),V={title:o,price:l,category:d,description:c,location:B,whatsapp:I,delivery:P,images:k,seller_id:t.currentUser.user.id,status:"active"},{error:C}=await r.from("items").insert([V]);if(C)throw C;if(!n){let m=t.currentUser.profile.listing_credits-1,{error:g}=await r.from("profiles").update({listing_credits:m}).eq("id",t.currentUser.user.id);g?console.error("Failed to deduct credit, but item was listed:",g):t.currentUser.profile.listing_credits=m}alert("Item listed successfully!"),T(),a("home")}catch(f){console.error("Error listing item:",f),alert(`There was an error listing your item: ${f.message}`)}finally{e.submitBtn.disabled=!1,e.submitBtn.innerHTML='<i data-lucide="plus-circle"></i><span>List Item (1 Credit)</span>',lucide.createIcons()}},T=()=>{e.sellForm.querySelector("form")?.reset(),t.sellFormFiles=[],e.previewSection.innerHTML=""},U=()=>{if(t.currentUser)if(t.currentUser.profile?.is_admin)e.remainingCredits.textContent="Unlimited",e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1;else{let s=t.currentUser.profile?.listing_credits||0;e.remainingCredits.textContent=s.toString(),s>0?(e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1):(e.noCreditsMsg.classList.remove("hidden"),e.submitBtn.disabled=!0)}},y=s=>{s?(e.loginTitle.textContent="Create Account",e.loginName.classList.remove("hidden"),e.loginRegion.classList.remove("hidden"),e.registerNote.classList.remove("hidden"),e.loginSubmit.textContent="Register",e.loginToggleText.textContent="Already have an account?",e.loginToggleBtn.textContent="Login"):(e.loginTitle.textContent="Welcome Back",e.loginName.classList.add("hidden"),e.loginRegion.classList.add("hidden"),e.registerNote.classList.add("hidden"),e.loginSubmit.textContent="Login",e.loginToggleText.textContent="Don't have an account?",e.loginToggleBtn.textContent="Register")},S=async()=>{let s=e.loginEmail.value,n=e.loginPassword.value;if(!s||!n){alert("Please enter email and password.");return}try{console.log("Attempting login with Supabase...");let{error:i}=await r.auth.signInWithPassword({email:s,password:n});if(i)throw i;a("home")}catch(i){alert(`Login failed: ${i.message}`)}},A=async()=>{let s=e.loginName.value,n=e.loginEmail.value,i=e.loginPhone.value,o=e.loginRegion.value,l=e.loginPassword.value;if(!s||!n||!i||!o||!l){alert("Please fill all fields.");return}try{console.log("Attempting registration with Supabase...");let{data:d,error:c}=await r.auth.signUp({email:n,password:l,options:{data:{name:s,phone:i,region:o}}});if(c)throw c;d.user?.identities?.length===0?alert("Could not register user. A user with this email may already exist and is unconfirmed."):(alert("Registration successful! Please check your email to confirm your account."),y(!1))}catch(d){alert(`Registration failed: ${d.message}`)}},M=async()=>{try{console.log("Logging out with Supabase...");let{error:s}=await r.auth.signOut();if(s)throw s}catch(s){alert(`Logout failed: ${s.message}`)}},u=async()=>{let s=e.searchInput.value.toLowerCase(),n=e.categoryFilter.value;try{let i=r.from("items").select("*").order("posted_at",{ascending:!1});n!=="all"&&(i=i.eq("category",n));let{data:o,error:l}=await i;if(l)throw l;let d=o;s&&(d=o.filter(c=>c.title.toLowerCase().includes(s)||c.description.toLowerCase().includes(s))),t.items=d,h(t.items)}catch(i){console.error("Error fetching items:",i),e.itemsGrid.innerHTML='<p class="text-center text-red-500">Could not load items. Please try again later.</p>'}};e.showLoginBtn.addEventListener("click",()=>a("login")),e.homeBtn.addEventListener("click",()=>a("home")),e.sellBtn.addEventListener("click",()=>a("sell")),e.myAdsBtn.addEventListener("click",()=>a("myAds")),e.favBtn.addEventListener("click",()=>a("favorites")),e.adminBtn.addEventListener("click",()=>a("admin")),e.submitBtn.addEventListener("click",F),e.importCreditsBtn.addEventListener("click",()=>a("importCredits")),e.logoutBtn.addEventListener("click",M),e.loginToggleBtn.addEventListener("click",()=>{let s=e.loginSubmit.textContent==="Login";y(s)}),e.loginSubmit.addEventListener("click",s=>{s.preventDefault(),e.loginSubmit.textContent==="Login"?S():A()}),e.searchInput.addEventListener("input",u),e.categoryFilter.addEventListener("change",u),document.body.addEventListener("click",s=>{let n=s.target.closest(".favorite-toggle-btn");if(n){let i=n.closest(".item-card");i&&x(i.dataset.id)}}),(()=>{r.auth.onAuthStateChange(async(s,n)=>{let i=n?.user||null;if(i){console.log("Auth state changed: User signed in ->",i.id);let{data:o,error:l}=await r.from("profiles").select("*").eq("id",i.id).single();if(l&&l.code!=="PGRST116")console.error("Error fetching user profile:",l),t.currentUser=null,t.favorites=[];else if(o)t.currentUser={user:i,profile:o},t.favorites=o.favorites||[];else{console.warn("Profile not found, creating one as a fallback.");let{data:d,error:c}=await r.from("profiles").insert([{id:i.id,name:i.user_metadata.name||"New User",phone:i.user_metadata.phone,region:i.user_metadata.region,email:i.email}]).select().single();c?(console.error("Error creating user profile:",c),t.currentUser={user:i,profile:null},t.favorites=[]):(t.currentUser={user:i,profile:d},t.favorites=d.favorites||[])}}else console.log("Auth state changed: User signed out."),t.currentUser=null,t.favorites=[];b(),t.currentView!=="login"&&t.currentView!=="register"&&a("home")}),a("home"),lucide.createIcons()})()});})();
//# sourceMappingURL=app.js.map
