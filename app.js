(()=>{var A={apiKey:"AIzaSyAhwth6PMIvo8ObnGq3AKZf2w_CNd2VzLY",authDomain:"ghanamarket-c83e9.firebaseapp.com",projectId:"ghanamarket-c83e9",storageBucket:"ghanamarket-c83e9.appspot.com",messagingSenderId:"359810222973",appId:"1:359810222973:web:b44760dc6c5584ac89da14"};firebase.initializeApp(A);document.addEventListener("DOMContentLoaded",()=>{let s={currentUser:null,items:[],favorites:[],sellFormFiles:[],currentView:"home"},e={homeView:document.getElementById("homeView"),loginForm:document.getElementById("loginForm"),sellForm:document.getElementById("sellForm"),myAdsView:document.getElementById("myAdsView"),favoritesView:document.getElementById("favoritesView"),adminView:document.getElementById("adminView"),importCreditsForm:document.getElementById("importCreditsForm"),userSection:document.getElementById("userSection"),loginSection:document.getElementById("loginSection"),showLoginBtn:document.getElementById("showLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),welcomeText:document.getElementById("welcomeText"),creditsDisplay:document.getElementById("creditsDisplay"),loginTitle:document.getElementById("loginTitle"),loginName:document.getElementById("loginName"),loginEmail:document.getElementById("loginEmail"),loginPhone:document.getElementById("loginPhone"),loginRegion:document.getElementById("loginRegion"),loginPassword:document.getElementById("loginPassword"),loginSubmit:document.getElementById("loginSubmit"),loginToggleBtn:document.getElementById("loginToggleBtn"),loginToggleText:document.getElementById("loginToggleText"),registerNote:document.getElementById("registerNote"),passwordGroup:document.getElementById("passwordGroup"),homeBtn:document.getElementById("homeBtn"),sellBtn:document.getElementById("sellBtn"),myAdsBtn:document.getElementById("myAdsBtn"),favBtn:document.getElementById("favBtn"),adminBtn:document.getElementById("adminBtn"),navButtons:document.querySelectorAll(".nav-btn"),submitBtn:document.getElementById("submitBtn"),itemTitle:document.getElementById("itemTitle"),itemPrice:document.getElementById("itemPrice"),itemCategory:document.getElementById("itemCategory"),itemDescription:document.getElementById("itemDescription"),itemLocation:document.getElementById("itemLocation"),itemWhatsApp:document.getElementById("itemWhatsApp"),previewSection:document.getElementById("previewSection"),remainingCredits:document.getElementById("remainingCredits"),noCreditsMsg:document.getElementById("noCreditsMsg"),itemsGrid:document.getElementById("itemsGrid"),noItemsMsg:document.getElementById("noItemsMsg"),itemCount:document.getElementById("itemCount"),showingCount:document.getElementById("showingCount"),totalCount:document.getElementById("totalCount"),favCount:document.getElementById("favCount"),favoritesCount:document.getElementById("favoritesCount"),favoritesGrid:document.getElementById("favoritesGrid"),noFavoritesMsg:document.getElementById("noFavoritesMsg"),importCreditsBtn:document.getElementById("importCreditsBtn"),searchInput:document.getElementById("searchInput"),categoryFilter:document.getElementById("categoryFilter")},y=[e.homeView,e.loginForm,e.sellForm,e.myAdsView,e.favoritesView,e.adminView,e.importCreditsForm],r=i=>{s.currentView=i,y.forEach(o=>o.classList.add("hidden")),e.navButtons.forEach(o=>o.classList.remove("active"));let t,n;switch(i){case"login":t=e.loginForm,e.loginEmail.value="",e.loginPhone.value="",e.loginPassword.value="",e.loginSubmit.classList.remove("hidden"),e.loginEmail.type="email",e.loginEmail.placeholder="Email";break;case"sell":t=e.sellForm,n=e.sellBtn,I();break;case"myAds":t=e.myAdsView,n=e.myAdsBtn;break;case"favorites":t=e.favoritesView,n=e.favBtn,u();break;case"admin":t=e.adminView,n=e.adminBtn;break;case"importCredits":t=e.importCreditsForm;break;case"home":default:t=e.homeView,n=e.homeBtn,c();break}t&&t.classList.remove("hidden"),n&&n.classList.add("active"),window.scrollTo(0,0)},B=()=>{s.currentUser&&s.currentUser.profile?(e.userSection.classList.remove("hidden"),e.loginSection.classList.add("hidden"),e.welcomeText.textContent=`Welcome, ${s.currentUser.profile.username}`,e.sellBtn.classList.remove("hidden"),e.myAdsBtn.classList.remove("hidden"),s.currentUser.profile.is_admin?(e.creditsDisplay.textContent="Unlimited Credits",e.adminBtn.classList.remove("hidden")):(e.creditsDisplay.textContent=`${s.currentUser.profile.listing_credits} Credits`,e.adminBtn.classList.add("hidden"))):(e.userSection.classList.add("hidden"),e.loginSection.classList.remove("hidden"),e.sellBtn.classList.add("hidden"),e.myAdsBtn.classList.add("hidden"),e.adminBtn.classList.add("hidden"))},g=i=>{e.itemsGrid.innerHTML="",i.length===0?e.noItemsMsg.classList.remove("hidden"):e.noItemsMsg.classList.add("hidden"),e.itemCount.textContent=i.length,e.showingCount.textContent=i.length,e.totalCount.textContent=i.length,i.forEach(t=>{let n=s.favorites.includes(t.id),o=document.createElement("div");o.className="card item-card",o.dataset.id=t.id,o.innerHTML=`
                <img src="${t.images&&t.images.length>0?t.images[0]:"https://placehold.co/300x200?text=No+Image"}" alt="${t.title}" class="item-image">
                <div class="item-content">
                    <div class="item-meta">
                        <span class="category-badge">${t.category}</span>
                        <span class="text-xs text-gray-500">${new Date(t.posted_at).toLocaleDateString()}</span>
                    </div>
                    <h3 class="item-title">${t.title}</h3>
                    <p class="item-description">${t.description}</p>
                </div>
                <div class="item-footer">
                    <div class="item-price">GHS ${t.price}</div>
                    <div class="item-actions">
                        <a href="https://wa.me/${t.whatsapp.replace("+","")}?text=Hi, I'm interested in your '${t.title}' on Ghana Market." target="_blank" class="btn btn-sm btn-primary">
                            <i data-lucide="message-circle"></i><span>WhatsApp</span>
                        </a>
                        <button class="btn btn-sm btn-secondary favorite-toggle-btn">
                            <i data-lucide="heart" ${n?'fill="red"':""}></i>
                        </button>
                    </div>
                </div>
            `,e.itemsGrid.appendChild(o)}),lucide.createIcons()},E=()=>{let i=s.favorites.length;e.favCount.textContent=i,e.favoritesCount&&(e.favoritesCount.textContent=i)},w=async i=>{if(!s.currentUser){alert("Please login to add items to your favorites."),r("login");return}let t=s.favorites.indexOf(i),n=[...s.favorites];t>-1?n.splice(t,1):n.push(i);try{let{error:o}=await supabaseClient.from("profiles").update({favorites:n}).eq("id",s.currentUser.user.id);if(o)throw o;s.favorites=n,s.currentUser.profile.favorites=n}catch(o){console.error("Error updating favorites:",o),alert("Could not update favorites. Please try again.");return}E(),s.currentView==="home"&&c(),s.currentView==="favorites"&&u()},u=async()=>{if(!s.favorites||s.favorites.length===0){e.favoritesGrid.innerHTML="",e.noFavoritesMsg.classList.remove("hidden");return}e.noFavoritesMsg.classList.add("hidden"),e.favoritesGrid.innerHTML="Loading favorites...";let{data:i,error:t}=await supabaseClient.from("items").select("*").in("id",s.favorites);if(t){console.error("Error fetching favorite items:",t),e.favoritesGrid.innerHTML='<p class="text-red-500">Could not load favorites.</p>';return}g(i)},C=async i=>{i.preventDefault();let t=firebase.auth().currentUser;if(!t){alert("You must be logged in to sell an item.");return}let n=e.itemTitle.value.trim(),o=parseFloat(e.itemPrice.value),a=e.itemCategory.value,l=e.itemDescription.value.trim(),d=e.itemLocation.value.trim(),h=e.itemWhatsApp.value.trim(),T=document.querySelector('input[name="deliveryType"]:checked').value;if(!n||!o||!a||!l||!d||!h){alert("Please fill out all required fields.");return}if(s.sellFormFiles.length===0){alert("Please upload at least one image for your item.");return}e.submitBtn.disabled=!0,e.submitBtn.innerHTML='<i data-lucide="loader-2" class="animate-spin"></i><span>Uploading...</span>',lucide.createIcons();try{let m=s.sellFormFiles.map(p=>{let S=`${Date.now()}-${p.name}`,v=firebase.storage().ref().child(`items/${t.uid}/${S}`);return v.put(p).then(M=>v.getDownloadURL())}),P=await Promise.all(m);await firebase.firestore().collection("items").add({title:n,price:o,category:a,description:l,location:d,whatsapp:h,delivery:T,images:P,seller_id:t.uid,status:"active",posted_at:firebase.firestore.FieldValue.serverTimestamp()}),alert("Item listed successfully!"),L(),r("home")}catch(m){console.error("Error listing item:",m),alert(`There was an error listing your item: ${m.message}`)}finally{e.submitBtn.disabled=!1,e.submitBtn.innerHTML='<i data-lucide="plus-circle"></i><span>List Item (1 Credit)</span>',lucide.createIcons()}},L=()=>{e.sellForm.querySelector("form")?.reset(),s.sellFormFiles=[],e.previewSection.innerHTML=""},I=()=>{if(s.currentUser)if(s.currentUser.profile?.is_admin)e.remainingCredits.textContent="Unlimited",e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1;else{let i=s.currentUser.profile?.listing_credits||0;e.remainingCredits.textContent=i.toString(),i>0?(e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1):(e.noCreditsMsg.classList.remove("hidden"),e.submitBtn.disabled=!0)}},f=i=>{i?(e.loginTitle.textContent="Create Account",e.loginName.classList.remove("hidden"),e.loginRegion.classList.remove("hidden"),e.registerNote.classList.remove("hidden"),e.loginSubmit.textContent="Register",e.loginToggleText.textContent="Already have an account?",e.loginToggleBtn.textContent="Login",e.loginEmail.type="email",e.loginEmail.placeholder="Email",e.loginPhone.classList.remove("hidden"),e.passwordGroup.classList.remove("hidden"),e.loginSubmit.classList.remove("hidden")):(e.loginTitle.textContent="Welcome Back",e.loginName.classList.add("hidden"),e.loginRegion.classList.add("hidden"),e.registerNote.classList.add("hidden"),e.loginSubmit.textContent="Login",e.loginToggleText.textContent="Don't have an account?",e.loginToggleBtn.textContent="Register",e.loginPhone.classList.add("hidden"),e.loginEmail.type="email",e.loginEmail.placeholder="Email")},b=async()=>{try{console.log("Logging out with Supabase...");let{error:i}=await supabaseClient.auth.signOut();if(i)throw i}catch(i){alert(`Logout failed: ${i.message}`)}},k=async()=>{let i=prompt("Please enter your email address to reset your password:");if(i)try{let{error:t}=await supabaseClient.auth.resetPasswordForEmail(i,{redirectTo:window.location.origin+"/update-password"});if(t)throw t;alert("Password reset email sent! Please check your inbox.")}catch(t){alert(`Error sending password reset email: ${t.message}`)}},c=async()=>{let i=e.searchInput.value.toLowerCase(),t=e.categoryFilter.value;try{let n=supabaseClient.from("items").select("*").order("posted_at",{ascending:!1});t!=="all"&&(n=n.eq("category",t));let{data:o,error:a}=await n;if(a)throw a;let l=o;i&&(l=o.filter(d=>d.title.toLowerCase().includes(i)||d.description.toLowerCase().includes(i))),s.items=l,g(s.items)}catch(n){console.error("Error fetching items:",n),e.itemsGrid.innerHTML='<p class="text-center text-red-500">Could not load items. Please try again later.</p>'}},F=async()=>{let i=e.loginEmail.value.trim(),t=e.loginPassword.value.trim();if(!i||!t){alert("Please enter both email and password.");return}try{await firebase.auth().signInWithEmailAndPassword(i,t),alert("Login successful!"),r("home")}catch(n){alert(`Login failed: ${n.message}`)}},x=async()=>{let i=e.loginEmail.value.trim(),t=e.loginPassword.value.trim(),n=e.loginName.value.trim(),o=e.loginPhone.value.trim(),a=e.loginRegion.value;if(!i||!t||!n||!o||!a){alert("Please fill out all fields for registration.");return}try{let l=await firebase.auth().createUserWithEmailAndPassword(i,t);await firebase.firestore().collection("users").doc(l.user.uid).set({username:n,phone:o,region:a,email:i}),alert("Registration successful! Please check your email to confirm your account."),f(!1)}catch(l){alert(`Registration failed: ${l.message}`)}};e.showLoginBtn.addEventListener("click",()=>r("login")),e.homeBtn.addEventListener("click",()=>r("home")),e.sellBtn.addEventListener("click",()=>r("sell")),e.myAdsBtn.addEventListener("click",()=>r("myAds")),e.favBtn.addEventListener("click",()=>r("favorites")),e.adminBtn.addEventListener("click",()=>r("admin")),e.submitBtn.addEventListener("click",C),e.importCreditsBtn.addEventListener("click",()=>r("importCredits")),e.logoutBtn.addEventListener("click",b),e.loginToggleBtn.addEventListener("click",()=>{let i=e.loginSubmit.textContent==="Login";f(i)}),e.loginSubmit.addEventListener("click",i=>{i.preventDefault(),e.loginSubmit.textContent==="Login"?F():x()}),e.searchInput.addEventListener("input",c),e.categoryFilter.addEventListener("change",c),document.body.addEventListener("click",i=>{let t=i.target.closest(".favorite-toggle-btn");if(t){let n=t.closest(".item-card");n&&w(n.dataset.id)}}),(()=>{supabaseClient.auth.onAuthStateChange(async(i,t)=>{let n=t?.user||null;if(n){console.log("Auth state changed: User signed in ->",n.id);let{data:o,error:a}=await supabaseClient.from("profiles").select("*").eq("id",n.id).single();if(a&&a.code!=="PGRST116")console.error("Error fetching user profile:",a),s.currentUser=null,s.favorites=[];else if(o)s.currentUser={user:n,profile:o},s.favorites=o.favorites||[];else{console.warn("Profile not found, creating one as a fallback.");let{data:l,error:d}=await supabaseClient.from("profiles").insert([{id:n.id,username:n.user_metadata.username||"New User"}]).select().single();d?(console.error("Error creating user profile:",d),s.currentUser={user:n,profile:null},s.favorites=[]):(s.currentUser={user:n,profile:l},s.favorites=l.favorites||[])}}else console.log("Auth state changed: User signed out."),s.currentUser=null,s.favorites=[];B(),s.currentView!=="login"&&s.currentView!=="register"&&r("home")}),r("home"),lucide.createIcons()})()});})();
//# sourceMappingURL=app.js.map
