(()=>{var G="https://acysegqhxdjhlhjotlhv.supabase.co",N="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjeXNlZ3FoeGRqaGxoam90bGh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3ODIzOTIsImV4cCI6MjA3MjM1ODM5Mn0.xYEIA_QPaaYJxGfuWzGDehrxJjETTR4A5T3votJb_8I",r=supabase.createClient(G,N);console.log("Supabase initialized.");document.addEventListener("DOMContentLoaded",()=>{let i={currentUser:null,items:[],favorites:[],sellFormFiles:[],currentView:"home"},e={homeView:document.getElementById("homeView"),loginForm:document.getElementById("loginForm"),sellForm:document.getElementById("sellForm"),myAdsView:document.getElementById("myAdsView"),favoritesView:document.getElementById("favoritesView"),adminView:document.getElementById("adminView"),importCreditsForm:document.getElementById("importCreditsForm"),userSection:document.getElementById("userSection"),loginSection:document.getElementById("loginSection"),showLoginBtn:document.getElementById("showLoginBtn"),logoutBtn:document.getElementById("logoutBtn"),welcomeText:document.getElementById("welcomeText"),creditsDisplay:document.getElementById("creditsDisplay"),loginTitle:document.getElementById("loginTitle"),loginName:document.getElementById("loginName"),loginEmail:document.getElementById("loginEmail"),loginPhone:document.getElementById("loginPhone"),loginRegion:document.getElementById("loginRegion"),loginPassword:document.getElementById("loginPassword"),loginSubmit:document.getElementById("loginSubmit"),loginToggleBtn:document.getElementById("loginToggleBtn"),loginToggleText:document.getElementById("loginToggleText"),registerNote:document.getElementById("registerNote"),forgotPasswordLink:document.getElementById("forgotPasswordLink"),navButtons:document.querySelectorAll(".nav-btn"),homeBtn:document.getElementById("homeBtn"),sellBtn:document.getElementById("sellBtn"),myAdsBtn:document.getElementById("myAdsBtn"),favBtn:document.getElementById("favBtn"),adminBtn:document.getElementById("adminBtn"),importCreditsBtn:document.getElementById("importCreditsBtn"),itemsGrid:document.getElementById("itemsGrid"),noItemsMsg:document.getElementById("noItemsMsg"),itemCount:document.getElementById("itemCount"),showingCount:document.getElementById("showingCount"),totalCount:document.getElementById("totalCount"),searchInput:document.getElementById("searchInput"),categoryFilter:document.getElementById("categoryFilter"),favCount:document.getElementById("favCount"),favoritesGrid:document.getElementById("favoritesGrid"),noFavoritesMsg:document.getElementById("noFavoritesMsg"),favoritesCount:document.getElementById("favoritesCount"),remainingCredits:document.getElementById("remainingCredits"),noCreditsMsg:document.getElementById("noCreditsMsg"),submitBtn:document.getElementById("submitBtn"),itemTitle:document.getElementById("itemTitle"),itemPrice:document.getElementById("itemPrice"),itemCategory:document.getElementById("itemCategory"),itemDescription:document.getElementById("itemDescription"),itemLocation:document.getElementById("itemLocation"),itemWhatsApp:document.getElementById("itemWhatsApp"),fileInput:document.getElementById("fileInput"),previewSection:document.getElementById("previewSection")},L=[e.homeView,e.loginForm,e.sellForm,e.myAdsView,e.favoritesView,e.adminView,e.importCreditsForm],a=n=>{i.currentView=n,L.forEach(o=>o.classList.add("hidden")),e.navButtons.forEach(o=>o.classList.remove("active"));let t,s;switch(n){case"login":t=e.loginForm;break;case"sell":t=e.sellForm,s=e.sellBtn,U();break;case"myAds":t=e.myAdsView,s=e.myAdsBtn;break;case"favorites":t=e.favoritesView,s=e.favBtn,v();break;case"admin":t=e.adminView,s=e.adminBtn;break;case"importCredits":t=e.importCreditsForm;break;case"home":default:t=e.homeView,s=e.homeBtn,g();break}t&&t.classList.remove("hidden"),s&&s.classList.add("active"),window.scrollTo(0,0)},b=()=>{i.currentUser&&i.currentUser.profile?(e.userSection.classList.remove("hidden"),e.loginSection.classList.add("hidden"),e.welcomeText.textContent=`Welcome, ${i.currentUser.profile.username}`,e.sellBtn.classList.remove("hidden"),e.myAdsBtn.classList.remove("hidden"),i.currentUser.profile.is_admin?(e.creditsDisplay.textContent="Unlimited Credits",e.adminBtn.classList.remove("hidden"),e.importCreditsBtn.classList.add("hidden")):(e.creditsDisplay.textContent=`${i.currentUser.profile.listing_credits} Credits`,e.adminBtn.classList.add("hidden"),e.importCreditsBtn.classList.remove("hidden"))):(e.userSection.classList.add("hidden"),e.loginSection.classList.remove("hidden"),e.sellBtn.classList.add("hidden"),e.myAdsBtn.classList.add("hidden"),e.adminBtn.classList.add("hidden")),p()},h=n=>{e.itemsGrid.innerHTML="",n.length===0?e.noItemsMsg.classList.remove("hidden"):e.noItemsMsg.classList.add("hidden"),e.itemCount.textContent=n.length,e.showingCount.textContent=n.length,e.totalCount.textContent=n.length,n.forEach(t=>{let s=i.favorites.includes(t.id),o=document.createElement("div");o.className="card item-card",o.dataset.id=t.id,o.innerHTML=`
                <img src="${t.images&&t.images.length>0?t.images[0]:"https://placehold.co/300x200?text=No+Image"}" alt="${t.title}" class="item-image">
                <div class="item-content">
                    <div class="item-meta">
                        <span class="category-badge">${t.category}</span>
                        <span class="text-xs text-gray-500">${new Date(t.posted_at).toLocaleDateString()}</span>
                    </div>
                    <h3 class="item-title">${t.title}</h3>
                    <p class="item-description">${t.description}</p>
                </div>
                <div class="item-footer">
                    <div class="item-price">GHS ${t.price}</div>
                    <div class="item-actions">
                        <a href="https://wa.me/${t.whatsapp.replace("+","")}?text=Hi, I'm interested in your '${t.title}' on Ghana Market." target="_blank" class="btn btn-sm btn-primary">
                            <i data-lucide="message-circle"></i><span>WhatsApp</span>
                        </a>
                        <button class="btn btn-sm btn-secondary favorite-toggle-btn">
                            <i data-lucide="heart" ${s?'fill="red"':""}></i>
                        </button>
                    </div>
                </div>
            `,e.itemsGrid.appendChild(o)}),lucide.createIcons()},p=()=>{let n=i.favorites.length;e.favCount.textContent=n,e.favoritesCount&&(e.favoritesCount.textContent=n)},F=async n=>{if(!i.currentUser){alert("Please login to add items to your favorites."),a("login");return}let t=i.favorites.indexOf(n),s=[...i.favorites];t>-1?s.splice(t,1):s.push(n);try{let{error:o}=await r.from("profiles").update({favorites:s}).eq("id",i.currentUser.user.id);if(o)throw o;i.favorites=s,i.currentUser.profile.favorites=s}catch(o){console.error("Error updating favorites:",o),alert("Could not update favorites. Please try again.");return}p(),i.currentView==="home"&&g(),i.currentView==="favorites"&&v()},v=async()=>{if(!i.favorites||i.favorites.length===0){e.favoritesGrid.innerHTML="",e.noFavoritesMsg.classList.remove("hidden");return}e.noFavoritesMsg.classList.add("hidden"),e.favoritesGrid.innerHTML="Loading favorites...";let{data:n,error:t}=await r.from("items").select("*").in("id",i.favorites);if(t){console.error("Error fetching favorite items:",t),e.favoritesGrid.innerHTML='<p class="text-red-500">Could not load favorites.</p>';return}h(n)},x=async n=>{if(n.preventDefault(),!i.currentUser){alert("You must be logged in to sell an item.");return}let{is_admin:t,listing_credits:s}=i.currentUser.profile;if(!t&&s<1){alert("You do not have enough credits to list an item.");return}let o=e.itemTitle.value.trim(),l=parseFloat(e.itemPrice.value),d=e.itemCategory.value,c=e.itemDescription.value.trim(),B=e.itemLocation.value.trim(),w=e.itemWhatsApp.value.trim(),M=document.querySelector('input[name="deliveryType"]:checked').value;if(!o||!l||!d||!c||!B||!w){alert("Please fill out all required fields.");return}if(i.sellFormFiles.length===0){alert("Please upload at least one image for your item.");return}e.submitBtn.disabled=!0,e.submitBtn.innerHTML='<i data-lucide="loader-2" class="animate-spin"></i><span>Uploading...</span>',lucide.createIcons();try{let f=i.sellFormFiles.map(m=>{let u=`${Date.now()}-${m.name}`,D=`${i.currentUser.user.id}/${u}`;return r.storage.from("item-images").upload(D,m)}),I=await Promise.all(f),E=I.filter(m=>m.error);if(E.length>0)throw new Error(`Image upload failed: ${E[0].error.message}`);let V=I.map(m=>{let{data:u}=r.storage.from("item-images").getPublicUrl(m.data.path);return u.publicUrl}),$={title:o,price:l,category:d,description:c,location:B,whatsapp:w,delivery:M,images:V,seller_id:i.currentUser.user.id,status:"active"},{error:C}=await r.from("items").insert([$]);if(C)throw C;if(!t){let m=i.currentUser.profile.listing_credits-1,{error:u}=await r.from("profiles").update({listing_credits:m}).eq("id",i.currentUser.user.id);u?console.error("Failed to deduct credit, but item was listed:",u):i.currentUser.profile.listing_credits=m}alert("Item listed successfully!"),T(),a("home")}catch(f){console.error("Error listing item:",f),alert(`There was an error listing your item: ${f.message}`)}finally{e.submitBtn.disabled=!1,e.submitBtn.innerHTML='<i data-lucide="plus-circle"></i><span>List Item (1 Credit)</span>',lucide.createIcons()}},T=()=>{e.sellForm.querySelector("form")?.reset(),i.sellFormFiles=[],e.previewSection.innerHTML=""},U=()=>{if(i.currentUser)if(i.currentUser.profile?.is_admin)e.remainingCredits.textContent="Unlimited",e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1;else{let n=i.currentUser.profile?.listing_credits||0;e.remainingCredits.textContent=n.toString(),n>0?(e.noCreditsMsg.classList.add("hidden"),e.submitBtn.disabled=!1):(e.noCreditsMsg.classList.remove("hidden"),e.submitBtn.disabled=!0)}},y=n=>{n?(e.loginTitle.textContent="Create Account",e.loginName.classList.remove("hidden"),e.loginRegion.classList.remove("hidden"),e.registerNote.classList.remove("hidden"),e.loginSubmit.textContent="Register",e.loginToggleText.textContent="Already have an account?",e.loginToggleBtn.textContent="Login"):(e.loginTitle.textContent="Welcome Back",e.loginName.classList.add("hidden"),e.loginRegion.classList.add("hidden"),e.registerNote.classList.add("hidden"),e.loginSubmit.textContent="Login",e.loginToggleText.textContent="Don't have an account?",e.loginToggleBtn.textContent="Register")},S=async()=>{let n=e.loginEmail.value,t=e.loginPassword.value;if(!n||!t){alert("Please enter email and password.");return}try{console.log("Attempting login with Supabase...");let{error:s}=await r.auth.signInWithPassword({email:n,password:t});if(s)throw s;a("home")}catch(s){alert(`Login failed: ${s.message}`)}},P=async()=>{let n=e.loginName.value,t=e.loginEmail.value,s=e.loginPhone.value,o=e.loginRegion.value,l=e.loginPassword.value;if(!n||!t||!s||!o||!l){alert("Please fill all fields.");return}try{console.log("Attempting registration with Supabase...");let{data:d,error:c}=await r.auth.signUp({email:t,password:l,options:{data:{username:n,phone:s,region:o}}});if(c)throw c;d.user?.identities?.length===0?alert("Could not register user. A user with this email may already exist and is unconfirmed."):(alert("Registration successful! Please check your email to confirm your account."),y(!1))}catch(d){alert(`Registration failed: ${d.message}`)}},A=async()=>{try{console.log("Logging out with Supabase...");let{error:n}=await r.auth.signOut();if(n)throw n}catch(n){alert(`Logout failed: ${n.message}`)}},k=async()=>{let n=prompt("Please enter your email address to reset your password:");if(n)try{let{error:t}=await r.auth.resetPasswordForEmail(n,{redirectTo:window.location.origin+"/update-password"});if(t)throw t;alert("Password reset email sent! Please check your inbox.")}catch(t){alert(`Error sending password reset email: ${t.message}`)}},g=async()=>{let n=e.searchInput.value.toLowerCase(),t=e.categoryFilter.value;try{let s=r.from("items").select("*").order("posted_at",{ascending:!1});t!=="all"&&(s=s.eq("category",t));let{data:o,error:l}=await s;if(l)throw l;let d=o;n&&(d=o.filter(c=>c.title.toLowerCase().includes(n)||c.description.toLowerCase().includes(n))),i.items=d,h(i.items)}catch(s){console.error("Error fetching items:",s),e.itemsGrid.innerHTML='<p class="text-center text-red-500">Could not load items. Please try again later.</p>'}};e.showLoginBtn.addEventListener("click",()=>a("login")),e.homeBtn.addEventListener("click",()=>a("home")),e.sellBtn.addEventListener("click",()=>a("sell")),e.myAdsBtn.addEventListener("click",()=>a("myAds")),e.favBtn.addEventListener("click",()=>a("favorites")),e.adminBtn.addEventListener("click",()=>a("admin")),e.submitBtn.addEventListener("click",x),e.importCreditsBtn.addEventListener("click",()=>a("importCredits")),e.logoutBtn.addEventListener("click",A),e.loginToggleBtn.addEventListener("click",()=>{let n=e.loginSubmit.textContent==="Login";y(n)}),e.loginSubmit.addEventListener("click",n=>{n.preventDefault(),e.loginSubmit.textContent==="Login"?S():P()}),e.forgotPasswordLink.addEventListener("click",n=>{n.preventDefault(),k()}),e.searchInput.addEventListener("input",g),e.categoryFilter.addEventListener("change",g),document.body.addEventListener("click",n=>{let t=n.target.closest(".favorite-toggle-btn");if(t){let s=t.closest(".item-card");s&&F(s.dataset.id)}}),(()=>{r.auth.onAuthStateChange(async(n,t)=>{let s=t?.user||null;if(s){console.log("Auth state changed: User signed in ->",s.id);let{data:o,error:l}=await r.from("profiles").select("*").eq("id",s.id).single();if(l&&l.code!=="PGRST116")console.error("Error fetching user profile:",l),i.currentUser=null,i.favorites=[];else if(o)i.currentUser={user:s,profile:o},i.favorites=o.favorites||[];else{console.warn("Profile not found, creating one as a fallback.");let{data:d,error:c}=await r.from("profiles").insert([{id:s.id,username:s.user_metadata.username||"New User"}]).select().single();c?(console.error("Error creating user profile:",c),i.currentUser={user:s,profile:null},i.favorites=[]):(i.currentUser={user:s,profile:d},i.favorites=d.favorites||[])}}else console.log("Auth state changed: User signed out."),i.currentUser=null,i.favorites=[];b(),i.currentView!=="login"&&i.currentView!=="register"&&a("home")}),a("home"),lucide.createIcons()})()});})();
//# sourceMappingURL=app.js.map
